{"id":"node_modules/@tensorflow-models/body-pix/multi_person/decode_instance_masks.js","dependencies":[{"name":"/Users/linazhao/tf/models/body-pix/demos/node_modules/@tensorflow-models/body-pix/multi_person/decode_instance_masks.js.map","includedInParent":true,"mtime":1613671120559},{"name":"/Users/linazhao/tf/models/body-pix/demos/package.json","includedInParent":true,"mtime":1613671076017},{"name":"/Users/linazhao/tf/models/body-pix/demos/.babelrc","includedInParent":true,"mtime":1608229350283},{"name":"@tensorflow/tfjs-core","loc":{"line":55,"column":26},"parent":"/Users/linazhao/tf/models/body-pix/demos/node_modules/@tensorflow-models/body-pix/multi_person/decode_instance_masks.js","resolved":"/Users/linazhao/tf/models/body-pix/demos/node_modules/@tensorflow/tfjs-core/dist/index.js"},{"name":"./decode_multiple_masks_cpu","loc":{"line":56,"column":42},"parent":"/Users/linazhao/tf/models/body-pix/demos/node_modules/@tensorflow-models/body-pix/multi_person/decode_instance_masks.js","resolved":"/Users/linazhao/tf/models/body-pix/demos/node_modules/@tensorflow-models/body-pix/multi_person/decode_multiple_masks_cpu.js"},{"name":"./decode_multiple_masks_webgl","loc":{"line":57,"column":44},"parent":"/Users/linazhao/tf/models/body-pix/demos/node_modules/@tensorflow-models/body-pix/multi_person/decode_instance_masks.js","resolved":"/Users/linazhao/tf/models/body-pix/demos/node_modules/@tensorflow-models/body-pix/multi_person/decode_multiple_masks_webgl.js"}],"generated":{"js":"\"use strict\";\n/**\n * @license\n * Copyright 2019 Google Inc. All Rights Reserved.\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n * =============================================================================\n */\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __generator = (this && this.__generator) || function (thisArg, body) {\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n    function verb(n) { return function (v) { return step([n, v]); }; }\n    function step(op) {\n        if (f) throw new TypeError(\"Generator is already executing.\");\n        while (_) try {\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n            if (y = 0, t) op = [op[0] & 2, t.value];\n            switch (op[0]) {\n                case 0: case 1: t = op; break;\n                case 4: _.label++; return { value: op[1], done: false };\n                case 5: _.label++; y = op[1]; op = [0]; continue;\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\n                default:\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                    if (t[2]) _.ops.pop();\n                    _.trys.pop(); continue;\n            }\n            op = body.call(thisArg, _);\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n    }\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar tf = require(\"@tensorflow/tfjs-core\");\nvar tfjs_core_1 = require(\"@tensorflow/tfjs-core\");\nvar decode_multiple_masks_cpu_1 = require(\"./decode_multiple_masks_cpu\");\nvar decode_multiple_masks_webgl_1 = require(\"./decode_multiple_masks_webgl\");\nfunction toPersonKSegmentation(segmentation, k) {\n    return tf.tidy(function () { return tf.cast(tf.equal(segmentation, tf.scalar(k)), 'int32'); });\n}\nexports.toPersonKSegmentation = toPersonKSegmentation;\nfunction toPersonKPartSegmentation(segmentation, bodyParts, k) {\n    return tf.tidy(function () { return tf.sub(tf.mul(tf.cast(tf.equal(segmentation, tf.scalar(k)), 'int32'), tf.add(bodyParts, 1)), 1); });\n}\nexports.toPersonKPartSegmentation = toPersonKPartSegmentation;\nfunction isWebGlBackend() {\n    return tfjs_core_1.getBackend() === 'webgl';\n}\nfunction decodePersonInstanceMasks(segmentation, longOffsets, poses, height, width, stride, _a, padding, minPoseScore, refineSteps, minKeypointScore, maxNumPeople) {\n    var inHeight = _a[0], inWidth = _a[1];\n    if (minPoseScore === void 0) { minPoseScore = 0.2; }\n    if (refineSteps === void 0) { refineSteps = 8; }\n    if (minKeypointScore === void 0) { minKeypointScore = 0.3; }\n    if (maxNumPeople === void 0) { maxNumPeople = 10; }\n    return __awaiter(this, void 0, void 0, function () {\n        var posesAboveScore, personSegmentationsData, personSegmentations, segmentationsData, longOffsetsData;\n        return __generator(this, function (_b) {\n            switch (_b.label) {\n                case 0:\n                    posesAboveScore = poses.filter(function (pose) { return pose.score >= minPoseScore; });\n                    if (!isWebGlBackend()) return [3 /*break*/, 2];\n                    personSegmentations = tf.tidy(function () {\n                        var masksTensorInfo = decode_multiple_masks_webgl_1.decodeMultipleMasksWebGl(segmentation, longOffsets, posesAboveScore, height, width, stride, [inHeight, inWidth], padding, refineSteps, minKeypointScore, maxNumPeople);\n                        var masksTensor = tf.engine().makeTensorFromDataId(masksTensorInfo.dataId, masksTensorInfo.shape, masksTensorInfo.dtype);\n                        return posesAboveScore.map(function (_, k) { return toPersonKSegmentation(masksTensor, k); });\n                    });\n                    return [4 /*yield*/, Promise.all(personSegmentations.map(function (mask) { return mask.data(); }))];\n                case 1:\n                    personSegmentationsData =\n                        (_b.sent());\n                    personSegmentations.forEach(function (x) { return x.dispose(); });\n                    return [3 /*break*/, 5];\n                case 2: return [4 /*yield*/, segmentation.data()];\n                case 3:\n                    segmentationsData = _b.sent();\n                    return [4 /*yield*/, longOffsets.data()];\n                case 4:\n                    longOffsetsData = _b.sent();\n                    personSegmentationsData = decode_multiple_masks_cpu_1.decodeMultipleMasksCPU(segmentationsData, longOffsetsData, posesAboveScore, height, width, stride, [inHeight, inWidth], padding, refineSteps);\n                    _b.label = 5;\n                case 5: return [2 /*return*/, personSegmentationsData.map(function (data, i) { return ({ data: data, pose: posesAboveScore[i], width: width, height: height }); })];\n            }\n        });\n    });\n}\nexports.decodePersonInstanceMasks = decodePersonInstanceMasks;\nfunction decodePersonInstancePartMasks(segmentation, longOffsets, partSegmentation, poses, height, width, stride, _a, padding, minPoseScore, refineSteps, minKeypointScore, maxNumPeople) {\n    var inHeight = _a[0], inWidth = _a[1];\n    if (minPoseScore === void 0) { minPoseScore = 0.2; }\n    if (refineSteps === void 0) { refineSteps = 8; }\n    if (minKeypointScore === void 0) { minKeypointScore = 0.3; }\n    if (maxNumPeople === void 0) { maxNumPeople = 10; }\n    return __awaiter(this, void 0, void 0, function () {\n        var posesAboveScore, partSegmentationsByPersonData, partSegmentations, segmentationsData, longOffsetsData, partSegmentaionData;\n        return __generator(this, function (_b) {\n            switch (_b.label) {\n                case 0:\n                    posesAboveScore = poses.filter(function (pose) { return pose.score >= minPoseScore; });\n                    if (!isWebGlBackend()) return [3 /*break*/, 2];\n                    partSegmentations = tf.tidy(function () {\n                        var masksTensorInfo = decode_multiple_masks_webgl_1.decodeMultipleMasksWebGl(segmentation, longOffsets, posesAboveScore, height, width, stride, [inHeight, inWidth], padding, refineSteps, minKeypointScore, maxNumPeople);\n                        var masksTensor = tf.engine().makeTensorFromDataId(masksTensorInfo.dataId, masksTensorInfo.shape, masksTensorInfo.dtype);\n                        return posesAboveScore.map(function (_, k) {\n                            return toPersonKPartSegmentation(masksTensor, partSegmentation, k);\n                        });\n                    });\n                    return [4 /*yield*/, Promise.all(partSegmentations.map(function (x) { return x.data(); }))];\n                case 1:\n                    partSegmentationsByPersonData =\n                        (_b.sent());\n                    partSegmentations.forEach(function (x) { return x.dispose(); });\n                    return [3 /*break*/, 6];\n                case 2: return [4 /*yield*/, segmentation.data()];\n                case 3:\n                    segmentationsData = _b.sent();\n                    return [4 /*yield*/, longOffsets.data()];\n                case 4:\n                    longOffsetsData = _b.sent();\n                    return [4 /*yield*/, partSegmentation.data()];\n                case 5:\n                    partSegmentaionData = _b.sent();\n                    partSegmentationsByPersonData = decode_multiple_masks_cpu_1.decodeMultiplePartMasksCPU(segmentationsData, longOffsetsData, partSegmentaionData, posesAboveScore, height, width, stride, [inHeight, inWidth], padding, refineSteps);\n                    _b.label = 6;\n                case 6: return [2 /*return*/, partSegmentationsByPersonData.map(function (data, k) { return ({ pose: posesAboveScore[k], data: data, height: height, width: width }); })];\n            }\n        });\n    });\n}\nexports.decodePersonInstancePartMasks = decodePersonInstancePartMasks;\n"},"sourceMaps":{"js":{"version":3,"file":"decode_instance_masks.js","sourceRoot":"","sources":["../../src/multi_person/decode_instance_masks.ts"],"names":[],"mappings":"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","sourcesContent":[null]}},"error":null,"hash":"750c91184669e67f8ad3cca644f8ea23","cacheData":{"env":{}}}